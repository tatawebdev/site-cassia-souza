import{r as f,j as e,H as I}from"./app-BpQUTjvg.js";import{A as F}from"./AuthenticatedLayout-Ddi-Cvm-.js";import"./ApplicationLogo-hEA8h877.js";import"./transition-Bfcdlv-n.js";function H(s){const t=s.messages&&s.messages.length?s.messages[s.messages.length-1].time:s.lastMessage||"";if(!t)return"Anteriores";const r=String(t).toLowerCase();return r.includes("hoje")||/^\d{1,2}:\d{2}$/.test(r)?"Hoje":r.includes("ontem")?"Ontem":"Anteriores"}function M(s){const t=m=>{if(!m)return NaN;const x=Date.parse(m);if(!isNaN(x))return x;const p=String(m).trim().toLowerCase(),u=p.match(/^(\d{1,2}):(\d{2})$/);if(u){const j=new Date;return j.setHours(parseInt(u[1],10),parseInt(u[2],10),0,0),j.getTime()}if(p.includes("hoje"))return Date.now();if(p.includes("ontem")){const j=new Date;return j.setDate(j.getDate()-1),j.getTime()}return NaN};if(s.lastAt){const m=t(s.lastAt);if(!isNaN(m))return m}const r=s.messages&&s.messages.length?s.messages[s.messages.length-1].time:s.lastMessage,l=t(r);return isNaN(l)?0:l}function T({contacts:s=[],selectedId:t,onSelect:r,groups:l=null}){const[m,x]=f.useState(""),p=f.useMemo(()=>s.filter(a=>a.name.toLowerCase().includes(m.toLowerCase())||(a.lastMessage||"").toLowerCase().includes(m.toLowerCase())).sort((a,h)=>M(h)-M(a)),[s,m]),u=f.useMemo(()=>{if(l&&Array.isArray(l)&&l.length)return null;const d={Hoje:[],Ontem:[],Anteriores:[]};return p.forEach(a=>{const h=H(a);d[h]||(d[h]=[]),d[h].push(a)}),d},[p,l]),j=["Hoje","Ontem","Anteriores"];return e.jsxs("div",{className:"w-full md:w-80 border-gray-200 h-full flex flex-col md:border-r md:border-b-0 border-b",children:[e.jsx("div",{className:"p-4",children:e.jsx("input",{className:"w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500",placeholder:"Pesquisar contatos",value:m,onChange:d=>x(d.target.value)})}),e.jsx("div",{className:"overflow-y-auto flex-1",children:l&&Array.isArray(l)&&l.length?l.map(d=>e.jsxs("div",{className:"pb-3",children:[e.jsx("div",{className:"px-4 py-2 text-xs font-semibold text-gray-500 uppercase",children:d.label}),d.items.map(a=>e.jsxs("button",{onClick:()=>r(a.id),className:`w-full text-left p-4 hover:bg-gray-50 flex items-start gap-3 ${t===a.id?"bg-gray-100":""}`,children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-indigo-200 flex items-center justify-center text-white font-semibold",children:String(a.name).split(" ").map(h=>h[0]).slice(0,2).join("")}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-medium text-sm",children:a.name}),a.unread>0&&e.jsx("div",{className:"text-xs bg-red-500 text-white rounded-full px-2 py-0.5",children:a.unread})]}),e.jsx("div",{className:"text-xs text-gray-500 truncate",children:a.lastMessage})]})]},a.id))]},d.key)):j.map(d=>u[d]&&u[d].length>0?e.jsxs("div",{className:"pb-3",children:[e.jsx("div",{className:"px-4 py-2 text-xs font-semibold text-gray-500 uppercase",children:d}),u[d].map(a=>e.jsxs("button",{onClick:()=>r(a.id),className:`w-full text-left p-4 hover:bg-gray-50 flex items-start gap-3 ${t===a.id?"bg-gray-100":""}`,children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-indigo-200 flex items-center justify-center text-white font-semibold",children:a.name.split(" ").map(h=>h[0]).slice(0,2).join("")}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-medium text-sm",children:a.name}),a.unread>0&&e.jsx("div",{className:"text-xs bg-red-500 text-white rounded-full px-2 py-0.5",children:a.unread})]}),e.jsx("div",{className:"text-xs text-gray-500 truncate",children:a.lastMessage})]})]},a.id))]},d):null)})]})}/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const O=s=>s.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),P=s=>s.replace(/^([A-Z])|[\s-_]+(\w)/g,(t,r,l)=>l?l.toUpperCase():r.toLowerCase()),E=s=>{const t=P(s);return t.charAt(0).toUpperCase()+t.slice(1)},k=(...s)=>s.filter((t,r,l)=>!!t&&t.trim()!==""&&l.indexOf(t)===r).join(" ").trim(),R=s=>{for(const t in s)if(t.startsWith("aria-")||t==="role"||t==="title")return!0};/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */var q={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const B=f.forwardRef(({color:s="currentColor",size:t=24,strokeWidth:r=2,absoluteStrokeWidth:l,className:m="",children:x,iconNode:p,...u},j)=>f.createElement("svg",{ref:j,...q,width:t,height:t,stroke:s,strokeWidth:l?Number(r)*24/Number(t):r,className:k("lucide",m),...!x&&!R(u)&&{"aria-hidden":"true"},...u},[...p.map(([d,a])=>f.createElement(d,a)),...Array.isArray(x)?x:[x]]));/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _=(s,t)=>{const r=f.forwardRef(({className:l,...m},x)=>f.createElement(B,{ref:x,iconNode:t,className:k(`lucide-${O(E(s))}`,`lucide-${s}`,l),...m}));return r.displayName=E(s),r};/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const z=[["path",{d:"M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z",key:"18887p"}]],U=_("message-square",z);/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const W=[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]],G=_("user",W);function J({message:s}){const t=s.from==="me"||s.from==="bot",r=t?G:U;return e.jsx("div",{className:`flex ${t?"justify-end":"justify-start"} mb-2`,children:e.jsxs("div",{className:`${t?"bg-primary text-white":"bg-gray-100 text-gray-800"} max-w-xs p-3 rounded-lg flex items-end gap-2`,children:[!t&&e.jsx("div",{className:"flex-shrink-0 mt-0",children:e.jsx(r,{size:18,className:"text-gray-500"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm",children:s.text}),e.jsx("div",{className:`text-xs mt-1 ${t?"text-primary-100":"text-gray-500"}`,children:s.time})]}),t&&e.jsx("div",{className:"flex-shrink-0",children:e.jsx(r,{size:18,className:"text-primary-100"})})]})})}function V({onSend:s,sending:t=!1}){const[r,l]=f.useState("");function m(x){x.preventDefault();const p=r.trim();!p||t||(s(p),l(""))}return e.jsxs("form",{onSubmit:m,className:"p-3 border-t border-gray-200 flex gap-2 items-center",children:[e.jsx("input",{value:r,onChange:x=>l(x.target.value),className:"flex-1 rounded-md border-gray-300 shadow-sm px-3 py-2 focus:outline-none",placeholder:"Escreva uma mensagem...",disabled:t}),e.jsx("button",{className:`px-4 py-2 rounded-md ${t?"bg-gray-300 text-gray-700":"bg-primary text-white"}`,type:"submit",disabled:t,children:t?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-4 w-4 border-2 border-t-primary-600 border-gray-200 rounded-full animate-spin"}),e.jsx("span",{className:"text-sm",children:"Enviando..."})]}):"Enviar"})]})}function Z({contact:s,messages:t=[],onSend:r,loading:l=!1,onReceive:m,sending:x=!1}){const p=f.useRef(null);return f.useEffect(()=>{p.current?.scrollIntoView({behavior:"smooth"})},[t,s]),f.useEffect(()=>{if(!m)return;function u(j){const d=j.detail||j;let a=d.data||d;if(typeof a=="string")try{a=JSON.parse(a)}catch{}const h=a.usuario_id||a.data&&a.data.usuario_id||a.user_id||a.usuario||null;if(!h||!s||h!=s.id)return;const C=a.mensagem||a.data&&a.data.mensagem||a.message||a.notification&&a.notification.body||"",b=a.remetente||a.data&&a.data.remetente||"user";console.log("FCM message for current contact:",b);const v=a.id||a.message_id||Date.now(),A=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),w={id:v,from:b==="me"?"me":"other",text:C,time:A};if(!(Array.isArray(t)&&t.some(o=>o.id==w.id))){console.log("new message:",w,a.data);try{m(w,h)}catch(o){console.error("onReceive handler error",o)}}}return window.addEventListener("fcm-message",u),()=>window.removeEventListener("fcm-message",u)},[m,s]),s?e.jsxs("div",{className:"flex-1 flex flex-col h-full",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-indigo-200 flex items-center justify-center text-white font-semibold",children:s.name.split(" ").map(u=>u[0]).slice(0,2).join("")}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.name}),e.jsx("div",{className:"text-xs text-gray-500",children:s.lastMessage})]})]}),e.jsxs("div",{className:"p-4 overflow-y-auto flex-1 relative",children:[l&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-white/60 z-10",children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx("div",{className:"h-8 w-8 border-4 border-t-primary-600 border-gray-200 rounded-full animate-spin"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Carregando mensagens..."})]})}),!l&&(!t||t.length===0)?e.jsx("div",{className:"h-full flex items-center justify-center text-gray-500",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mb-2",children:"Nenhuma mensagem ainda"}),e.jsx("div",{className:"text-xs",children:"Envie a primeira mensagem para iniciar a conversa."})]})}):t.map(u=>e.jsx(J,{message:u},u.id)),e.jsx("div",{ref:p})]}),e.jsx(V,{onSend:r,sending:x})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsx("div",{className:"text-gray-500",children:"Selecione um contato para iniciar a conversa"})})}const K=[];function te(){const[s,t]=f.useState(K.map(n=>({...n}))),[r,l]=f.useState(null),[m,x]=f.useState(!0),[p,u]=f.useState(null),[j,d]=f.useState(null),[a,h]=f.useState(null);function C(n){l(n),t(c=>c.map(g=>g.id===n?{...g,unread:0}:g));const o=s.find(c=>c.id===n);o&&(!o.messages||o.messages.length===0)&&w(n)}function b(n){if(!r)return;const o=s.find(c=>c.id===r);o&&(h(r),window.axios.post(route("chat.api.storeMessage"),{usuario_id:o.id,mensagem:n,remetente:"me"}).then(()=>{h(null)}).catch(c=>{h(null),console.error("Erro ao enviar mensagem",c)}))}const v=s.find(n=>n.id===r)||null;f.useEffect(()=>{x(!0),window.axios.get(route("chat.api.contacts")).then(n=>{if(n.data&&n.data.groups){d(n.data.groups);const o=n.data.groups[0]?.items?.[0];o&&l(g=>g??o.id);const c=n.data.groups.flatMap(g=>g.items.map(i=>({...i,messages:i.messages||[]})));t(c)}else{const o=n.data.map(c=>({...c,messages:c.messages||[]}));t(o),o.length>0&&l(c=>c??o[0].id)}}).catch(n=>{console.warn("Não foi possível carregar contatos via API, usando mock",n)}).finally(()=>x(!1))},[]);function A(n,o){t(c=>c.map(g=>{if(g.id!==o)return g;const i=[...g.messages||[],n];return{...g,messages:i,lastMessage:n.text,unread:r===o?0:(g.unread||0)+1}}))}f.useEffect(()=>{const n={current:{}};function o(c){const g=c.detail||c;let i=g.data||g;if(typeof i=="string")try{i=JSON.parse(i)}catch{}const N=i.usuario_id||i.data&&i.data.usuario_id||i.user_id||i.usuario||null;if(i.mensagem||i.data&&i.data.mensagem||i.message||i.notification&&i.notification.body,!N)return;const $=Date.now();n.current[N],n.current[N]=$;const S=i.id||i.message_id||Date.now();console.log(i),t(L=>L.map(y=>y.id!=N||(y.messages||[]).some(D=>D.id==S)?y:{...y,lastMessage:i.mensagem,unread:(y.unread||0)+1,messages:[...y.messages||[],{id:S,from:i.remetente||"them",text:i.mensagem,time:i.time||new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),type:i.type}]})),w(N)}return window.addEventListener("fcm-message",o),()=>window.removeEventListener("fcm-message",o)},[r]);function w(n){u(n),window.axios.get(route("chat.api.messages",{usuario:n})).then(o=>{const c=o.data;t(g=>g.map(i=>i.id!==n?i:{...i,messages:c})),v?.id===n&&(v.messages=c)}).catch(o=>{console.warn("Erro ao buscar mensagens",o)}).finally(()=>u(null))}return e.jsxs(F,{header:e.jsx("h2",{className:"text-xl font-semibold leading-tight text-gray-800",children:"Chat de Contatos"}),children:[e.jsx(I,{title:"Chat"}),e.jsx("div",{className:"py-6",children:e.jsx("div",{className:"mx-auto max-w-7xl sm:px-6 lg:px-8",children:e.jsx("div",{className:"bg-white shadow-sm sm:rounded-lg overflow-hidden",style:{height:"70vh"},children:e.jsxs("div",{className:"flex h-full flex-col md:flex-row",children:[e.jsx(T,{contacts:s,selectedId:r,onSelect:C,groups:j}),e.jsx("div",{className:"flex-1 h-full",children:e.jsx(Z,{contact:v,messages:v?.messages||[],onReceive:A,onSend:b,loading:p===r,sending:a===r})})]})})})})]})}export{te as default};
