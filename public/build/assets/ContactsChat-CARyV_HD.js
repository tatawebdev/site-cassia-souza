import{r as h,j as e,H as L}from"./app-Dteo4US6.js";import{A as D}from"./AuthenticatedLayout-DiB8lMcW.js";import"./ApplicationLogo-D5kfZhdH.js";import"./transition-CJMOU5pU.js";function R(a){const i=a.messages&&a.messages.length?a.messages[a.messages.length-1].time:a.lastMessage||"";if(!i)return"Anteriores";const m=String(i).toLowerCase();return m.includes("hoje")||/^\d{1,2}:\d{2}$/.test(m)?"Hoje":m.includes("ontem")?"Ontem":"Anteriores"}function S(a){const i=u=>{if(!u)return NaN;const v=Date.parse(u);if(!isNaN(v))return v;const f=String(u).trim().toLowerCase(),p=f.match(/^(\d{1,2}):(\d{2})$/);if(p){const b=new Date;return b.setHours(parseInt(p[1],10),parseInt(p[2],10),0,0),b.getTime()}if(f.includes("hoje"))return Date.now();if(f.includes("ontem")){const b=new Date;return b.setDate(b.getDate()-1),b.getTime()}return NaN};if(a.lastAt){const u=i(a.lastAt);if(!isNaN(u))return u}const m=a.messages&&a.messages.length?a.messages[a.messages.length-1].time:a.lastMessage,l=i(m);return isNaN(l)?0:l}function T({contacts:a=[],selectedId:i,onSelect:m,groups:l=null}){const[u,v]=h.useState(""),f=h.useMemo(()=>a.filter(n=>n.name.toLowerCase().includes(u.toLowerCase())||(n.lastMessage||"").toLowerCase().includes(u.toLowerCase())).sort((n,j)=>S(j)-S(n)),[a,u]),p=h.useMemo(()=>{if(l&&Array.isArray(l)&&l.length)return null;const t={Hoje:[],Ontem:[],Anteriores:[]};return f.forEach(n=>{const j=R(n);t[j]||(t[j]=[]),t[j].push(n)}),t},[f,l]),b=["Hoje","Ontem","Anteriores"];return e.jsxs("div",{className:"w-80 border-r border-gray-200 h-full flex flex-col",children:[e.jsx("div",{className:"p-4",children:e.jsx("input",{className:"w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500",placeholder:"Pesquisar contatos",value:u,onChange:t=>v(t.target.value)})}),e.jsx("div",{className:"overflow-y-auto flex-1",children:l&&Array.isArray(l)&&l.length?l.map(t=>e.jsxs("div",{className:"pb-3",children:[e.jsx("div",{className:"px-4 py-2 text-xs font-semibold text-gray-500 uppercase",children:t.label}),t.items.map(n=>e.jsxs("button",{onClick:()=>m(n.id),className:`w-full text-left p-4 hover:bg-gray-50 flex items-start gap-3 ${i===n.id?"bg-gray-100":""}`,children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-indigo-200 flex items-center justify-center text-white font-semibold",children:String(n.name).split(" ").map(j=>j[0]).slice(0,2).join("")}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-medium text-sm",children:n.name}),n.unread>0&&e.jsx("div",{className:"text-xs bg-red-500 text-white rounded-full px-2 py-0.5",children:n.unread})]}),e.jsx("div",{className:"text-xs text-gray-500 truncate",children:n.lastMessage})]})]},n.id))]},t.key)):b.map(t=>p[t]&&p[t].length>0?e.jsxs("div",{className:"pb-3",children:[e.jsx("div",{className:"px-4 py-2 text-xs font-semibold text-gray-500 uppercase",children:t}),p[t].map(n=>e.jsxs("button",{onClick:()=>m(n.id),className:`w-full text-left p-4 hover:bg-gray-50 flex items-start gap-3 ${i===n.id?"bg-gray-100":""}`,children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-indigo-200 flex items-center justify-center text-white font-semibold",children:n.name.split(" ").map(j=>j[0]).slice(0,2).join("")}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-medium text-sm",children:n.name}),n.unread>0&&e.jsx("div",{className:"text-xs bg-red-500 text-white rounded-full px-2 py-0.5",children:n.unread})]}),e.jsx("div",{className:"text-xs text-gray-500 truncate",children:n.lastMessage})]})]},n.id))]},t):null)})]})}function _({message:a}){const i=a.from==="me";return e.jsx("div",{className:`flex ${i?"justify-end":"justify-start"} mb-2`,children:e.jsxs("div",{className:`${i?"bg-indigo-600 text-white":"bg-gray-100 text-gray-800"} max-w-xs p-3 rounded-lg`,children:[e.jsx("div",{className:"text-sm",children:a.text}),e.jsx("div",{className:`text-xs mt-1 ${i?"text-indigo-100":"text-gray-500"}`,children:a.time})]})})}function F({onSend:a}){const[i,m]=h.useState("");function l(u){u.preventDefault();const v=i.trim();v&&(a(v),m(""))}return e.jsxs("form",{onSubmit:l,className:"p-3 border-t border-gray-200 flex gap-2 items-center",children:[e.jsx("input",{value:i,onChange:u=>m(u.target.value),className:"flex-1 rounded-md border-gray-300 shadow-sm px-3 py-2 focus:outline-none",placeholder:"Escreva uma mensagem..."}),e.jsx("button",{className:"bg-indigo-600 text-white px-4 py-2 rounded-md",type:"submit",children:"Enviar"})]})}function H({contact:a,messages:i=[],onSend:m,loading:l=!1,onReceive:u}){const v=h.useRef(null);return h.useEffect(()=>{v.current?.scrollIntoView({behavior:"smooth"})},[i,a]),h.useEffect(()=>{if(!u)return;function f(p){const b=p.detail||p;let t=b.data||b;if(typeof t=="string")try{t=JSON.parse(t)}catch{}const n=t.usuario_id||t.data&&t.data.usuario_id||t.user_id||t.usuario||null;if(!n||!a||n!=a.id)return;const j=t.mensagem||t.data&&t.data.mensagem||t.message||t.notification&&t.notification.body||"",C=t.remetente||t.data&&t.data.remetente||"user",P=t.id||t.message_id||Date.now(),A=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),s={id:P,from:C==="me"?"me":"other",text:j,time:A};if(!(Array.isArray(i)&&i.some(o=>o.id==s.id))){console.log("new message:",s,t.data);try{u(s,n)}catch(o){console.error("onReceive handler error",o)}}}return window.addEventListener("fcm-message",f),()=>window.removeEventListener("fcm-message",f)},[u,a]),a?e.jsxs("div",{className:"flex-1 flex flex-col h-full",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-indigo-200 flex items-center justify-center text-white font-semibold",children:a.name.split(" ").map(f=>f[0]).slice(0,2).join("")}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:a.name}),e.jsx("div",{className:"text-xs text-gray-500",children:a.lastMessage})]})]}),e.jsxs("div",{className:"p-4 overflow-y-auto flex-1 relative",children:[l&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-white/60 z-10",children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx("div",{className:"h-8 w-8 border-4 border-t-indigo-600 border-gray-200 rounded-full animate-spin"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Carregando mensagens..."})]})}),!l&&(!i||i.length===0)?e.jsx("div",{className:"h-full flex items-center justify-center text-gray-500",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mb-2",children:"Nenhuma mensagem ainda"}),e.jsx("div",{className:"text-xs",children:"Envie a primeira mensagem para iniciar a conversa."})]})}):i.map(f=>e.jsx(_,{message:f},f.id)),e.jsx("div",{ref:v})]}),e.jsx(F,{onSend:m})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsx("div",{className:"text-gray-500",children:"Selecione um contato para iniciar a conversa"})})}const I=[{id:1,name:"João Silva",avatar:null,unread:2,lastMessage:"Até mais tarde!",messages:[{id:1,from:"contact",text:"Olá, você tem um minuto?",time:"09:10"},{id:2,from:"me",text:"Tenho sim, diga.",time:"09:12"},{id:3,from:"contact",text:"Perfeito — até mais tarde!",time:"09:15"}]},{id:2,name:"Maria Oliveira",avatar:null,unread:0,lastMessage:"Obrigado pelo retorno.",messages:[{id:1,from:"contact",text:"Você pode me encaminhar os documentos?",time:"08:05"},{id:2,from:"me",text:"Já enviei por e-mail.",time:"08:10"},{id:3,from:"contact",text:"Obrigado pelo retorno.",time:"08:12"}]},{id:3,name:"Carlos Pereira",avatar:null,unread:5,lastMessage:"Pode ligar mais tarde?",messages:[{id:1,from:"contact",text:"Oi, está disponível?",time:"Ontem"},{id:2,from:"contact",text:"Preciso agendar uma reunião.",time:"Ontem"},{id:3,from:"me",text:"Posso sim — qual horário?",time:"Ontem"},{id:4,from:"contact",text:"Pode ligar mais tarde?",time:"Hoje"}]},{id:4,name:"Ana Souza",avatar:null,unread:0,lastMessage:"Recebi, obrigado.",messages:[{id:1,from:"me",text:"Enviei o contrato.",time:"10:05"},{id:2,from:"contact",text:"Recebi, obrigado.",time:"10:07"}]},{id:5,name:"Pedro Lima",avatar:null,unread:1,lastMessage:"Amanhã de manhã?",messages:[{id:1,from:"contact",text:"Tem como amanhã de manhã?",time:"Ontem"}]},{id:6,name:"Mariana Costa",avatar:null,unread:0,lastMessage:"Confirmado.",messages:[{id:1,from:"me",text:"Agendei para sexta.",time:"09:00"},{id:2,from:"contact",text:"Confirmado.",time:"09:02"}]},{id:7,name:"Lucas Ferreira",avatar:null,unread:3,lastMessage:"Enviei as fotos.",messages:[{id:1,from:"contact",text:"Enviei as fotos.",time:"08:30"},{id:2,from:"me",text:"Recebi, vou olhar.",time:"08:45"}]},{id:8,name:"Patrícia Gomes",avatar:null,unread:0,lastMessage:"Obrigado pela atenção.",messages:[{id:1,from:"contact",text:"Obrigado pela atenção.",time:"Ontem"}]},{id:9,name:"Rafael Alves",avatar:null,unread:0,lastMessage:"Ok, combinado.",messages:[{id:1,from:"me",text:"Posso ligar às 15h?",time:"14:55"},{id:2,from:"contact",text:"Ok, combinado.",time:"14:57"}]},{id:10,name:"Sofia Martins",avatar:null,unread:0,lastMessage:"Recebi a confirmação.",messages:[{id:1,from:"contact",text:"Recebi a confirmação.",time:"Ontem"}]},{id:11,name:"Bruno Rocha",avatar:null,unread:0,lastMessage:"Obrigado!",messages:[{id:1,from:"me",text:"Pronto, verifiquei.",time:"11:20"},{id:2,from:"contact",text:"Obrigado!",time:"11:22"}]},{id:12,name:"Camila Ribeiro",avatar:null,unread:2,lastMessage:"Pode enviar novamente?",messages:[{id:1,from:"contact",text:"Não chegou o arquivo.",time:"Ontem"},{id:2,from:"contact",text:"Pode enviar novamente?",time:"Hoje"}]},{id:13,name:"Diego Nunes",avatar:null,unread:0,lastMessage:"Tudo certo.",messages:[{id:1,from:"contact",text:"Tudo certo.",time:"2025-10-28"}]},{id:14,name:"Elisa Andrade",avatar:null,unread:0,lastMessage:"Aguardo retorno.",messages:[{id:1,from:"contact",text:"Aguardo retorno.",time:"2025-10-25"}]},{id:15,name:"Fábio Mendes",avatar:null,unread:0,lastMessage:"Posso ligar?",messages:[{id:1,from:"contact",text:"Posso ligar?",time:"Ontem"}]},{id:16,name:"Gabriela Pinto",avatar:null,unread:4,lastMessage:"Envie-me o orçamento.",messages:[{id:1,from:"contact",text:"Envie-me o orçamento.",time:"07:40"},{id:2,from:"me",text:"Já enviei.",time:"07:55"}]},{id:17,name:"Henrique Carvalho",avatar:null,unread:0,lastMessage:"Obrigado pelo suporte.",messages:[{id:1,from:"contact",text:"Obrigado pelo suporte.",time:"2025-09-10"}]},{id:18,name:"Isabela Castro",avatar:null,unread:0,lastMessage:"Posso confirmar?",messages:[{id:1,from:"contact",text:"Posso confirmar?",time:"Ontem"}]},{id:19,name:"Joana Lima",avatar:null,unread:1,lastMessage:"Vamos marcar?",messages:[{id:1,from:"contact",text:"Vamos marcar?",time:"09:45"}]},{id:20,name:"Kevin Barros",avatar:null,unread:0,lastMessage:"Recebido.",messages:[{id:1,from:"me",text:"Enviei o relatório.",time:"2025-10-01"},{id:2,from:"contact",text:"Recebido.",time:"2025-10-02"}]},{id:21,name:"Larissa Freitas",avatar:null,unread:0,lastMessage:"Confirmado! Obrigada",messages:[{id:1,from:"contact",text:"Confirmado! Obrigada",time:"Ontem"}]},{id:22,name:"Marcelo Dias",avatar:null,unread:0,lastMessage:"Vou revisar e retorno.",messages:[{id:1,from:"contact",text:"Vou revisar e retorno.",time:"2025-09-20"}]},{id:23,name:"Natália Lopes",avatar:null,unread:0,lastMessage:"Perfeito.",messages:[{id:1,from:"me",text:"Atualizei o documento.",time:"13:00"},{id:2,from:"contact",text:"Perfeito.",time:"13:05"}]},{id:24,name:"Otávio Reis",avatar:null,unread:2,lastMessage:"Qual o valor?",messages:[{id:1,from:"contact",text:"Qual o valor?",time:"08:15"},{id:2,from:"contact",text:"Pode me enviar a tabela?",time:"08:16"}]},{id:25,name:"Priscila Moraes",avatar:null,unread:0,lastMessage:"Agradeço o retorno.",messages:[{id:1,from:"contact",text:"Agradeço o retorno.",time:"2025-08-30"}]},{id:26,name:"Quintino Alves",avatar:null,unread:0,lastMessage:"Confirmado",messages:[{id:1,from:"contact",text:"Confirmado",time:"Ontem"}]},{id:27,name:"Rosa Fernandes",avatar:null,unread:0,lastMessage:"Até breve",messages:[{id:1,from:"contact",text:"Até breve",time:"2025-07-12"}]},{id:28,name:"Samuel Teixeira",avatar:null,unread:0,lastMessage:"Podemos reagendar?",messages:[{id:1,from:"contact",text:"Podemos reagendar?",time:"Ontem"}]},{id:29,name:"Talita Nascimento",avatar:null,unread:0,lastMessage:"Recebido, obrigada.",messages:[{id:1,from:"me",text:"Enviei os detalhes.",time:"10:30"},{id:2,from:"contact",text:"Recebido, obrigada.",time:"10:32"}]},{id:30,name:"Uiliam Gomes",avatar:null,unread:6,lastMessage:"Preciso falar urgente.",messages:[{id:1,from:"contact",text:"Preciso falar urgente.",time:"07:10"},{id:2,from:"contact",text:"Você está disponível?",time:"07:12"}]}];function J(){const[a,i]=h.useState(I.map(s=>({...s}))),[m,l]=h.useState(null),[u,v]=h.useState(!0),[f,p]=h.useState(null),[b,t]=h.useState(null);function n(s){l(s),i(o=>o.map(g=>g.id===s?{...g,unread:0}:g));const d=a.find(o=>o.id===s);d&&(!d.messages||d.messages.length===0)&&A(s)}function j(s){if(!m)return;const d=a.find(N=>N.id===m);if(!d)return;const o=`temp_${Date.now()}`,g=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),r={id:o,from:"me",text:s,time:g};i(N=>N.map(x=>x.id!==m?x:{...x,messages:[...x.messages||[],r],lastMessage:s})),window.axios.post(route("chat.api.storeMessage"),{usuario_id:d.id,mensagem:s,remetente:"me"}).then(N=>{const x=N.data.data;i(w=>w.map(y=>{if(y.id!==m)return y;const E=(y.messages||[]).map(M=>M.id===o?{id:x.id,from:x.from,text:x.text,time:x.time}:M);return{...y,messages:E,lastMessage:x.text}}))}).catch(N=>{i(x=>x.map(w=>w.id!==m?w:{...w,messages:(w.messages||[]).filter(y=>y.id!==o)})),console.error("Erro ao enviar mensagem",N)})}const C=a.find(s=>s.id===m)||null;h.useEffect(()=>{v(!0),window.axios.get(route("chat.api.contacts")).then(s=>{if(s.data&&s.data.groups){t(s.data.groups);const d=s.data.groups[0]?.items?.[0];d&&l(g=>g??d.id);const o=s.data.groups.flatMap(g=>g.items.map(r=>({...r,messages:r.messages||[]})));i(o)}else{const d=s.data.map(o=>({...o,messages:o.messages||[]}));i(d),d.length>0&&l(o=>o??d[0].id)}}).catch(s=>{console.warn("Não foi possível carregar contatos via API, usando mock",s)}).finally(()=>v(!1))},[]);function P(s,d){i(o=>o.map(g=>{if(g.id!==d)return g;const r=[...g.messages||[],s];return{...g,messages:r,lastMessage:s.text,unread:m===d?0:(g.unread||0)+1}}))}h.useEffect(()=>{const s={current:{}};function d(o){const g=o.detail||o;let r=g.data||g;if(typeof r=="string")try{r=JSON.parse(r)}catch{}const N=r.usuario_id||r.data&&r.data.usuario_id||r.user_id||r.usuario||null;if(r.mensagem||r.data&&r.data.mensagem||r.message||r.notification&&r.notification.body,!N)return;const x=Date.now(),w=s.current[N]||0;if(x-w<5e3)return;s.current[N]=x;const y=r.id||r.message_id||Date.now();if((c.messages||[]).some(M=>M.id==y))return c;i(M=>M.map(O=>O.id!=N?O:{...O,lastMessage:r.mensagem,unread:(O.unread||0)+1,messages:[...O.messages||[],{id:y,from:r.remetente||"them",text:r.mensagem,time:r.time||new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),type:r.type}]})),A(N)}return window.addEventListener("fcm-message",d),()=>window.removeEventListener("fcm-message",d)},[m]);function A(s){p(s),window.axios.get(route("chat.api.messages",{usuario:s})).then(d=>{const o=d.data;i(g=>g.map(r=>r.id!==s?r:{...r,messages:o})),C?.id===s&&(C.messages=o)}).catch(d=>{console.warn("Erro ao buscar mensagens",d)}).finally(()=>p(null))}return e.jsxs(D,{header:e.jsx("h2",{className:"text-xl font-semibold leading-tight text-gray-800",children:"Chat de Contatos"}),children:[e.jsx(L,{title:"Chat"}),e.jsx("div",{className:"py-6",children:e.jsx("div",{className:"mx-auto max-w-7xl sm:px-6 lg:px-8",children:e.jsx("div",{className:"bg-white shadow-sm sm:rounded-lg overflow-hidden",style:{height:"70vh"},children:e.jsxs("div",{className:"flex h-full",children:[e.jsx(T,{contacts:a,selectedId:m,onSelect:n,groups:b}),e.jsx("div",{className:"flex-1 h-full",children:e.jsx(H,{contact:C,messages:C?.messages||[],onReceive:P,onSend:j,loading:f===m})})]})})})})]})}export{J as default};
