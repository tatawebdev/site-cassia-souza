import{r as x,j as e,H as D}from"./app-ZxyZplcd.js";import{A as _}from"./AuthenticatedLayout-CGb2WkLL.js";import"./ApplicationLogo-8sq0fbd1.js";import"./transition-DFrKK3Dt.js";function $(a){const t=a.messages&&a.messages.length?a.messages[a.messages.length-1].time:a.lastMessage||"";if(!t)return"Anteriores";const r=String(t).toLowerCase();return r.includes("hoje")||/^\d{1,2}:\d{2}$/.test(r)?"Hoje":r.includes("ontem")?"Ontem":"Anteriores"}function E(a){const t=u=>{if(!u)return NaN;const f=Date.parse(u);if(!isNaN(f))return f;const v=String(u).trim().toLowerCase(),g=v.match(/^(\d{1,2}):(\d{2})$/);if(g){const p=new Date;return p.setHours(parseInt(g[1],10),parseInt(g[2],10),0,0),p.getTime()}if(v.includes("hoje"))return Date.now();if(v.includes("ontem")){const p=new Date;return p.setDate(p.getDate()-1),p.getTime()}return NaN};if(a.lastAt){const u=t(a.lastAt);if(!isNaN(u))return u}const r=a.messages&&a.messages.length?a.messages[a.messages.length-1].time:a.lastMessage,o=t(r);return isNaN(o)?0:o}function I({contacts:a=[],selectedId:t,onSelect:r,groups:o=null}){const[u,f]=x.useState(""),v=x.useMemo(()=>a.filter(s=>s.name.toLowerCase().includes(u.toLowerCase())||(s.lastMessage||"").toLowerCase().includes(u.toLowerCase())).sort((s,h)=>E(h)-E(s)),[a,u]),g=x.useMemo(()=>{if(o&&Array.isArray(o)&&o.length)return null;const l={Hoje:[],Ontem:[],Anteriores:[]};return v.forEach(s=>{const h=$(s);l[h]||(l[h]=[]),l[h].push(s)}),l},[v,o]),p=["Hoje","Ontem","Anteriores"];return e.jsxs("div",{className:"w-80 border-r border-gray-200 h-full flex flex-col",children:[e.jsx("div",{className:"p-4",children:e.jsx("input",{className:"w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500",placeholder:"Pesquisar contatos",value:u,onChange:l=>f(l.target.value)})}),e.jsx("div",{className:"overflow-y-auto flex-1",children:o&&Array.isArray(o)&&o.length?o.map(l=>e.jsxs("div",{className:"pb-3",children:[e.jsx("div",{className:"px-4 py-2 text-xs font-semibold text-gray-500 uppercase",children:l.label}),l.items.map(s=>e.jsxs("button",{onClick:()=>r(s.id),className:`w-full text-left p-4 hover:bg-gray-50 flex items-start gap-3 ${t===s.id?"bg-gray-100":""}`,children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-indigo-200 flex items-center justify-center text-white font-semibold",children:String(s.name).split(" ").map(h=>h[0]).slice(0,2).join("")}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-medium text-sm",children:s.name}),s.unread>0&&e.jsx("div",{className:"text-xs bg-red-500 text-white rounded-full px-2 py-0.5",children:s.unread})]}),e.jsx("div",{className:"text-xs text-gray-500 truncate",children:s.lastMessage})]})]},s.id))]},l.key)):p.map(l=>g[l]&&g[l].length>0?e.jsxs("div",{className:"pb-3",children:[e.jsx("div",{className:"px-4 py-2 text-xs font-semibold text-gray-500 uppercase",children:l}),g[l].map(s=>e.jsxs("button",{onClick:()=>r(s.id),className:`w-full text-left p-4 hover:bg-gray-50 flex items-start gap-3 ${t===s.id?"bg-gray-100":""}`,children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-indigo-200 flex items-center justify-center text-white font-semibold",children:s.name.split(" ").map(h=>h[0]).slice(0,2).join("")}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-medium text-sm",children:s.name}),s.unread>0&&e.jsx("div",{className:"text-xs bg-red-500 text-white rounded-full px-2 py-0.5",children:s.unread})]}),e.jsx("div",{className:"text-xs text-gray-500 truncate",children:s.lastMessage})]})]},s.id))]},l):null)})]})}/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const T=a=>a.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),F=a=>a.replace(/^([A-Z])|[\s-_]+(\w)/g,(t,r,o)=>o?o.toUpperCase():r.toLowerCase()),L=a=>{const t=F(a);return t.charAt(0).toUpperCase()+t.slice(1)},S=(...a)=>a.filter((t,r,o)=>!!t&&t.trim()!==""&&o.indexOf(t)===r).join(" ").trim(),H=a=>{for(const t in a)if(t.startsWith("aria-")||t==="role"||t==="title")return!0};/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */var q={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const V=x.forwardRef(({color:a="currentColor",size:t=24,strokeWidth:r=2,absoluteStrokeWidth:o,className:u="",children:f,iconNode:v,...g},p)=>x.createElement("svg",{ref:p,...q,width:t,height:t,stroke:a,strokeWidth:o?Number(r)*24/Number(t):r,className:S("lucide",u),...!f&&!H(g)&&{"aria-hidden":"true"},...g},[...v.map(([l,s])=>x.createElement(l,s)),...Array.isArray(f)?f:[f]]));/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const R=(a,t)=>{const r=x.forwardRef(({className:o,...u},f)=>x.createElement(V,{ref:f,iconNode:t,className:S(`lucide-${T(L(a))}`,`lucide-${a}`,o),...u}));return r.displayName=L(a),r};/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const B=[["path",{d:"M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z",key:"18887p"}]],J=R("message-square",B);/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const z=[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]],G=R("user",z);function Q({message:a}){const t=a.from==="me"||a.from==="bot",r=t?G:J;return e.jsx("div",{className:`flex ${t?"justify-end":"justify-start"} mb-2`,children:e.jsxs("div",{className:`${t?"bg-indigo-600 text-white":"bg-gray-100 text-gray-800"} max-w-xs p-3 rounded-lg flex items-end gap-2`,children:[!t&&e.jsx("div",{className:"flex-shrink-0 mt-0",children:e.jsx(r,{size:18,className:"text-gray-500"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm",children:a.text}),e.jsx("div",{className:`text-xs mt-1 ${t?"text-indigo-100":"text-gray-500"}`,children:a.time})]}),t&&e.jsx("div",{className:"flex-shrink-0",children:e.jsx(r,{size:18,className:"text-indigo-100"})})]})})}function U({onSend:a,sending:t=!1}){const[r,o]=x.useState("");function u(f){f.preventDefault();const v=r.trim();!v||t||(a(v),o(""))}return e.jsxs("form",{onSubmit:u,className:"p-3 border-t border-gray-200 flex gap-2 items-center",children:[e.jsx("input",{value:r,onChange:f=>o(f.target.value),className:"flex-1 rounded-md border-gray-300 shadow-sm px-3 py-2 focus:outline-none",placeholder:"Escreva uma mensagem...",disabled:t}),e.jsx("button",{className:`px-4 py-2 rounded-md ${t?"bg-gray-300 text-gray-700":"bg-indigo-600 text-white"}`,type:"submit",disabled:t,children:t?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-4 w-4 border-2 border-t-indigo-600 border-gray-200 rounded-full animate-spin"}),e.jsx("span",{className:"text-sm",children:"Enviando..."})]}):"Enviar"})]})}function W({contact:a,messages:t=[],onSend:r,loading:o=!1,onReceive:u,sending:f=!1}){const v=x.useRef(null);return x.useEffect(()=>{v.current?.scrollIntoView({behavior:"smooth"})},[t,a]),x.useEffect(()=>{if(!u)return;function g(p){const l=p.detail||p;let s=l.data||l;if(typeof s=="string")try{s=JSON.parse(s)}catch{}const h=s.usuario_id||s.data&&s.data.usuario_id||s.user_id||s.usuario||null;if(!h||!a||h!=a.id)return;const C=s.mensagem||s.data&&s.data.mensagem||s.message||s.notification&&s.notification.body||"",M=s.remetente||s.data&&s.data.remetente||"user";console.log("FCM message for current contact:",M);const y=s.id||s.message_id||Date.now(),A=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),N={id:y,from:M==="me"?"me":"other",text:C,time:A};if(!(Array.isArray(t)&&t.some(m=>m.id==N.id))){console.log("new message:",N,s.data);try{u(N,h)}catch(m){console.error("onReceive handler error",m)}}}return window.addEventListener("fcm-message",g),()=>window.removeEventListener("fcm-message",g)},[u,a]),a?e.jsxs("div",{className:"flex-1 flex flex-col h-full",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-indigo-200 flex items-center justify-center text-white font-semibold",children:a.name.split(" ").map(g=>g[0]).slice(0,2).join("")}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:a.name}),e.jsx("div",{className:"text-xs text-gray-500",children:a.lastMessage})]})]}),e.jsxs("div",{className:"p-4 overflow-y-auto flex-1 relative",children:[o&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-white/60 z-10",children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx("div",{className:"h-8 w-8 border-4 border-t-indigo-600 border-gray-200 rounded-full animate-spin"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Carregando mensagens..."})]})}),!o&&(!t||t.length===0)?e.jsx("div",{className:"h-full flex items-center justify-center text-gray-500",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mb-2",children:"Nenhuma mensagem ainda"}),e.jsx("div",{className:"text-xs",children:"Envie a primeira mensagem para iniciar a conversa."})]})}):t.map(g=>e.jsx(Q,{message:g},g.id)),e.jsx("div",{ref:v})]}),e.jsx(U,{onSend:r,sending:f})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsx("div",{className:"text-gray-500",children:"Selecione um contato para iniciar a conversa"})})}const K=[{id:1,name:"João Silva",avatar:null,unread:2,lastMessage:"Até mais tarde!",messages:[{id:1,from:"contact",text:"Olá, você tem um minuto?",time:"09:10"},{id:2,from:"me",text:"Tenho sim, diga.",time:"09:12"},{id:3,from:"contact",text:"Perfeito — até mais tarde!",time:"09:15"}]},{id:2,name:"Maria Oliveira",avatar:null,unread:0,lastMessage:"Obrigado pelo retorno.",messages:[{id:1,from:"contact",text:"Você pode me encaminhar os documentos?",time:"08:05"},{id:2,from:"me",text:"Já enviei por e-mail.",time:"08:10"},{id:3,from:"contact",text:"Obrigado pelo retorno.",time:"08:12"}]},{id:3,name:"Carlos Pereira",avatar:null,unread:5,lastMessage:"Pode ligar mais tarde?",messages:[{id:1,from:"contact",text:"Oi, está disponível?",time:"Ontem"},{id:2,from:"contact",text:"Preciso agendar uma reunião.",time:"Ontem"},{id:3,from:"me",text:"Posso sim — qual horário?",time:"Ontem"},{id:4,from:"contact",text:"Pode ligar mais tarde?",time:"Hoje"}]},{id:4,name:"Ana Souza",avatar:null,unread:0,lastMessage:"Recebi, obrigado.",messages:[{id:1,from:"me",text:"Enviei o contrato.",time:"10:05"},{id:2,from:"contact",text:"Recebi, obrigado.",time:"10:07"}]},{id:5,name:"Pedro Lima",avatar:null,unread:1,lastMessage:"Amanhã de manhã?",messages:[{id:1,from:"contact",text:"Tem como amanhã de manhã?",time:"Ontem"}]},{id:6,name:"Mariana Costa",avatar:null,unread:0,lastMessage:"Confirmado.",messages:[{id:1,from:"me",text:"Agendei para sexta.",time:"09:00"},{id:2,from:"contact",text:"Confirmado.",time:"09:02"}]},{id:7,name:"Lucas Ferreira",avatar:null,unread:3,lastMessage:"Enviei as fotos.",messages:[{id:1,from:"contact",text:"Enviei as fotos.",time:"08:30"},{id:2,from:"me",text:"Recebi, vou olhar.",time:"08:45"}]},{id:8,name:"Patrícia Gomes",avatar:null,unread:0,lastMessage:"Obrigado pela atenção.",messages:[{id:1,from:"contact",text:"Obrigado pela atenção.",time:"Ontem"}]},{id:9,name:"Rafael Alves",avatar:null,unread:0,lastMessage:"Ok, combinado.",messages:[{id:1,from:"me",text:"Posso ligar às 15h?",time:"14:55"},{id:2,from:"contact",text:"Ok, combinado.",time:"14:57"}]},{id:10,name:"Sofia Martins",avatar:null,unread:0,lastMessage:"Recebi a confirmação.",messages:[{id:1,from:"contact",text:"Recebi a confirmação.",time:"Ontem"}]},{id:11,name:"Bruno Rocha",avatar:null,unread:0,lastMessage:"Obrigado!",messages:[{id:1,from:"me",text:"Pronto, verifiquei.",time:"11:20"},{id:2,from:"contact",text:"Obrigado!",time:"11:22"}]},{id:12,name:"Camila Ribeiro",avatar:null,unread:2,lastMessage:"Pode enviar novamente?",messages:[{id:1,from:"contact",text:"Não chegou o arquivo.",time:"Ontem"},{id:2,from:"contact",text:"Pode enviar novamente?",time:"Hoje"}]},{id:13,name:"Diego Nunes",avatar:null,unread:0,lastMessage:"Tudo certo.",messages:[{id:1,from:"contact",text:"Tudo certo.",time:"2025-10-28"}]},{id:14,name:"Elisa Andrade",avatar:null,unread:0,lastMessage:"Aguardo retorno.",messages:[{id:1,from:"contact",text:"Aguardo retorno.",time:"2025-10-25"}]},{id:15,name:"Fábio Mendes",avatar:null,unread:0,lastMessage:"Posso ligar?",messages:[{id:1,from:"contact",text:"Posso ligar?",time:"Ontem"}]},{id:16,name:"Gabriela Pinto",avatar:null,unread:4,lastMessage:"Envie-me o orçamento.",messages:[{id:1,from:"contact",text:"Envie-me o orçamento.",time:"07:40"},{id:2,from:"me",text:"Já enviei.",time:"07:55"}]},{id:17,name:"Henrique Carvalho",avatar:null,unread:0,lastMessage:"Obrigado pelo suporte.",messages:[{id:1,from:"contact",text:"Obrigado pelo suporte.",time:"2025-09-10"}]},{id:18,name:"Isabela Castro",avatar:null,unread:0,lastMessage:"Posso confirmar?",messages:[{id:1,from:"contact",text:"Posso confirmar?",time:"Ontem"}]},{id:19,name:"Joana Lima",avatar:null,unread:1,lastMessage:"Vamos marcar?",messages:[{id:1,from:"contact",text:"Vamos marcar?",time:"09:45"}]},{id:20,name:"Kevin Barros",avatar:null,unread:0,lastMessage:"Recebido.",messages:[{id:1,from:"me",text:"Enviei o relatório.",time:"2025-10-01"},{id:2,from:"contact",text:"Recebido.",time:"2025-10-02"}]},{id:21,name:"Larissa Freitas",avatar:null,unread:0,lastMessage:"Confirmado! Obrigada",messages:[{id:1,from:"contact",text:"Confirmado! Obrigada",time:"Ontem"}]},{id:22,name:"Marcelo Dias",avatar:null,unread:0,lastMessage:"Vou revisar e retorno.",messages:[{id:1,from:"contact",text:"Vou revisar e retorno.",time:"2025-09-20"}]},{id:23,name:"Natália Lopes",avatar:null,unread:0,lastMessage:"Perfeito.",messages:[{id:1,from:"me",text:"Atualizei o documento.",time:"13:00"},{id:2,from:"contact",text:"Perfeito.",time:"13:05"}]},{id:24,name:"Otávio Reis",avatar:null,unread:2,lastMessage:"Qual o valor?",messages:[{id:1,from:"contact",text:"Qual o valor?",time:"08:15"},{id:2,from:"contact",text:"Pode me enviar a tabela?",time:"08:16"}]},{id:25,name:"Priscila Moraes",avatar:null,unread:0,lastMessage:"Agradeço o retorno.",messages:[{id:1,from:"contact",text:"Agradeço o retorno.",time:"2025-08-30"}]},{id:26,name:"Quintino Alves",avatar:null,unread:0,lastMessage:"Confirmado",messages:[{id:1,from:"contact",text:"Confirmado",time:"Ontem"}]},{id:27,name:"Rosa Fernandes",avatar:null,unread:0,lastMessage:"Até breve",messages:[{id:1,from:"contact",text:"Até breve",time:"2025-07-12"}]},{id:28,name:"Samuel Teixeira",avatar:null,unread:0,lastMessage:"Podemos reagendar?",messages:[{id:1,from:"contact",text:"Podemos reagendar?",time:"Ontem"}]},{id:29,name:"Talita Nascimento",avatar:null,unread:0,lastMessage:"Recebido, obrigada.",messages:[{id:1,from:"me",text:"Enviei os detalhes.",time:"10:30"},{id:2,from:"contact",text:"Recebido, obrigada.",time:"10:32"}]},{id:30,name:"Uiliam Gomes",avatar:null,unread:6,lastMessage:"Preciso falar urgente.",messages:[{id:1,from:"contact",text:"Preciso falar urgente.",time:"07:10"},{id:2,from:"contact",text:"Você está disponível?",time:"07:12"}]}];function ae(){const[a,t]=x.useState(K.map(n=>({...n}))),[r,o]=x.useState(null),[u,f]=x.useState(!0),[v,g]=x.useState(null),[p,l]=x.useState(null),[s,h]=x.useState(null);function C(n){o(n),t(c=>c.map(d=>d.id===n?{...d,unread:0}:d));const m=a.find(c=>c.id===n);m&&(!m.messages||m.messages.length===0)&&N(n)}function M(n){if(!r)return;const m=a.find(c=>c.id===r);m&&(h(r),window.axios.post(route("chat.api.storeMessage"),{usuario_id:m.id,mensagem:n,remetente:"me"}).then(c=>{const d=c.data.data;t(i=>i.map(b=>{if(b.id!==r)return b;const O=(b.messages||[]).map(w=>w.id===tempId?{id:d.id,from:d.from,text:d.text,time:d.time}:w);return{...b,messages:O,lastMessage:d.text}})),h(null)}).catch(c=>{t(d=>d.map(i=>i.id!==r?i:{...i,messages:(i.messages||[]).filter(b=>b.id!==tempId)})),h(null),console.error("Erro ao enviar mensagem",c)}))}const y=a.find(n=>n.id===r)||null;x.useEffect(()=>{f(!0),window.axios.get(route("chat.api.contacts")).then(n=>{if(n.data&&n.data.groups){l(n.data.groups);const m=n.data.groups[0]?.items?.[0];m&&o(d=>d??m.id);const c=n.data.groups.flatMap(d=>d.items.map(i=>({...i,messages:i.messages||[]})));t(c)}else{const m=n.data.map(c=>({...c,messages:c.messages||[]}));t(m),m.length>0&&o(c=>c??m[0].id)}}).catch(n=>{console.warn("Não foi possível carregar contatos via API, usando mock",n)}).finally(()=>f(!1))},[]);function A(n,m){t(c=>c.map(d=>{if(d.id!==m)return d;const i=[...d.messages||[],n];return{...d,messages:i,lastMessage:n.text,unread:r===m?0:(d.unread||0)+1}}))}x.useEffect(()=>{const n={current:{}};function m(c){const d=c.detail||c;let i=d.data||d;if(typeof i=="string")try{i=JSON.parse(i)}catch{}const b=i.usuario_id||i.data&&i.data.usuario_id||i.user_id||i.usuario||null;if(i.mensagem||i.data&&i.data.mensagem||i.message||i.notification&&i.notification.body,!b)return;const O=Date.now();n.current[b],n.current[b]=O;const w=i.id||i.message_id||Date.now();console.log(i),t(P=>P.map(j=>j.id!=b||(j.messages||[]).some(k=>k.id==w)?j:{...j,lastMessage:i.mensagem,unread:(j.unread||0)+1,messages:[...j.messages||[],{id:w,from:i.remetente||"them",text:i.mensagem,time:i.time||new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),type:i.type}]})),N(b)}return window.addEventListener("fcm-message",m),()=>window.removeEventListener("fcm-message",m)},[r]);function N(n){g(n),window.axios.get(route("chat.api.messages",{usuario:n})).then(m=>{const c=m.data;t(d=>d.map(i=>i.id!==n?i:{...i,messages:c})),y?.id===n&&(y.messages=c)}).catch(m=>{console.warn("Erro ao buscar mensagens",m)}).finally(()=>g(null))}return e.jsxs(_,{header:e.jsx("h2",{className:"text-xl font-semibold leading-tight text-gray-800",children:"Chat de Contatos"}),children:[e.jsx(D,{title:"Chat"}),e.jsx("div",{className:"py-6",children:e.jsx("div",{className:"mx-auto max-w-7xl sm:px-6 lg:px-8",children:e.jsx("div",{className:"bg-white shadow-sm sm:rounded-lg overflow-hidden",style:{height:"70vh"},children:e.jsxs("div",{className:"flex h-full",children:[e.jsx(I,{contacts:a,selectedId:r,onSelect:C,groups:p}),e.jsx("div",{className:"flex-1 h-full",children:e.jsx(W,{contact:y,messages:y?.messages||[],onReceive:A,onSend:M,loading:v===r,sending:s===r})})]})})})})]})}export{ae as default};
