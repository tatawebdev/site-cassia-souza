import{r as f,j as e,H as z}from"./app-DQ-3_Jh_.js";import{A as T}from"./AuthenticatedLayout-Q8FDu9YH.js";import{c as I}from"./createLucideIcon-B0ZuBtel.js";import"./ApplicationLogo-CX4zrWg3.js";import"./transition-C42rvPfi.js";/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const O=[["path",{d:"M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z",key:"18887p"}]],R=I("message-square",O);/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const W=[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]],q=I("user",W);function B(s){const t=s.messages&&s.messages.length?s.messages[s.messages.length-1].time:s.lastMessage||"";if(!t)return"Anteriores";const i=String(t).toLowerCase();return i.includes("hoje")||/^\d{1,2}:\d{2}$/.test(i)?"Hoje":i.includes("ontem")?"Ontem":"Anteriores"}function D(s){const t=u=>{if(!u)return NaN;const p=Date.parse(u);if(!isNaN(p))return p;const h=String(u).trim().toLowerCase(),j=h.match(/^(\d{1,2}):(\d{2})$/);if(j){const v=new Date;return v.setHours(parseInt(j[1],10),parseInt(j[2],10),0,0),v.getTime()}if(h.includes("hoje"))return Date.now();if(h.includes("ontem")){const v=new Date;return v.setDate(v.getDate()-1),v.getTime()}return NaN};if(s.lastAt){const u=t(s.lastAt);if(!isNaN(u))return u}const i=s.messages&&s.messages.length?s.messages[s.messages.length-1].time:s.lastMessage,c=t(i);return isNaN(c)?0:c}function P({contacts:s=[],selectedId:t,onSelect:i,groups:c=null}){const[u,p]=f.useState(""),h=f.useMemo(()=>s.filter(n=>n.name.toLowerCase().includes(u.toLowerCase())||(n.lastMessage||"").toLowerCase().includes(u.toLowerCase())).sort((n,g)=>D(g)-D(n)),[s,u]),j=f.useMemo(()=>{if(c&&Array.isArray(c)&&c.length)return null;const l={Hoje:[],Ontem:[],Anteriores:[]};return h.forEach(n=>{const g=B(n);l[g]||(l[g]=[]),l[g].push(n)}),l},[h,c]),v=["Hoje","Ontem","Anteriores"];return e.jsxs("div",{className:"w-full md:w-80  border-gray-200 h-full flex flex-col md:border-r md:border-b-0 border-b",children:[e.jsx("div",{className:"p-4",children:e.jsx("input",{className:"w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500",placeholder:"Pesquisar contatos",value:u,onChange:l=>p(l.target.value)})}),e.jsx("div",{className:"overflow-y-auto flex-1",children:c&&Array.isArray(c)&&c.length?c.map(l=>e.jsxs("div",{className:"pb-3",children:[e.jsx("div",{className:"px-4 py-2 text-xs font-semibold text-gray-500 uppercase",children:l.label}),l.items.map(n=>e.jsxs("button",{onClick:()=>i(n.id),className:`w-full text-left p-4 hover:bg-gray-50 flex items-start gap-3 ${t===n.id?"bg-gray-100":""}`,children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-indigo-200 flex items-center justify-center text-white font-semibold",children:String(n.name).split(" ").map(g=>g[0]).slice(0,2).join("")}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-medium text-sm",children:n.name}),n.unread>0&&e.jsx("div",{className:"text-xs bg-red-500 text-white rounded-full px-2 py-0.5",children:n.unread})]}),e.jsx("div",{className:"text-xs text-gray-500 truncate max-w-[200px]",children:n.lastMessage})]})]},n.id))]},l.key)):v.map(l=>j[l]&&j[l].length>0?e.jsxs("div",{className:"pb-3",children:[e.jsx("div",{className:"px-4 py-2 text-xs font-semibold text-gray-500 uppercase",children:l}),j[l].map(n=>e.jsxs("button",{onClick:()=>i(n.id),className:`w-full text-left p-4 hover:bg-gray-50 flex items-start gap-3 ${t===n.id?"bg-gray-100":""}`,children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-indigo-200 flex items-center justify-center text-white font-semibold",children:n.name.split(" ").map(g=>g[0]).slice(0,2).join("")}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-medium text-sm",children:n.name}),n.unread>0&&e.jsx("div",{className:"text-xs bg-red-500 text-white rounded-full px-2 py-0.5",children:n.unread})]}),e.jsx("div",{className:"text-xs text-gray-500 truncate max-w-[200px]",children:n.lastMessage})]})]},n.id))]},l):null)})]})}function G({message:s}){const t=s.from==="me"||s.from==="bot",i=t?q:R;return e.jsx("div",{className:`flex ${t?"justify-end":"justify-start"} mb-2`,children:e.jsxs("div",{className:`${t?"bg-primary text-white":"bg-gray-100 text-gray-800"} max-w-xs p-3 rounded-lg flex items-end gap-2`,children:[!t&&e.jsx("div",{className:"flex-shrink-0 mt-0",children:e.jsx(i,{size:18,className:"text-gray-500"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm",children:s.text}),e.jsx("div",{className:`text-xs mt-1 ${t?"text-primary-100":"text-gray-500"}`,children:s.time})]}),t&&e.jsx("div",{className:"flex-shrink-0",children:e.jsx(i,{size:18,className:"text-primary-100"})})]})})}function J({onSend:s,sending:t=!1}){const[i,c]=f.useState("");function u(p){p.preventDefault();const h=i.trim();!h||t||(s(h),c(""))}return e.jsxs("form",{onSubmit:u,className:"p-3 border-t border-gray-200 flex gap-2 items-center",children:[e.jsx("input",{value:i,onChange:p=>c(p.target.value),className:"flex-1 rounded-md border-gray-300 shadow-sm px-3 py-2 focus:outline-none",placeholder:"Escreva uma mensagem...",disabled:t}),e.jsx("button",{className:`px-4 py-2 rounded-md ${t?"bg-gray-300 text-gray-700":"bg-primary text-white"}`,type:"submit",disabled:t,children:t?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-4 w-4 border-2 border-t-primary-600 border-gray-200 rounded-full animate-spin"}),e.jsx("span",{className:"text-sm",children:"Enviando..."})]}):"Enviar"})]})}function $({contact:s,messages:t=[],onSend:i,loading:c=!1,onReceive:u,sending:p=!1,isMobile:h=!1,onBack:j=null}){const v=f.useRef(null);return f.useEffect(()=>{v.current?.scrollIntoView({behavior:"smooth"})},[t,s]),f.useEffect(()=>{if(!u)return;function l(n){const g=n.detail||n;let d=g.data||g;if(typeof d=="string")try{d=JSON.parse(d)}catch{}const C=d.usuario_id||d.data&&d.data.usuario_id||d.user_id||d.usuario||null;if(!C||!s||C!=s.id)return;const w=d.mensagem||d.data&&d.data.mensagem||d.message||d.notification&&d.notification.body||"",y=d.remetente||d.data&&d.data.remetente||"user";console.log("FCM message for current contact:",y);const k=d.id||d.message_id||Date.now(),S=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),N={id:k,from:y==="me"?"me":"other",text:w,time:S};if(!(Array.isArray(t)&&t.some(b=>b.id==N.id))){console.log("new message:",N,d.data);try{u(N,C)}catch(b){console.error("onReceive handler error",b)}}}return window.addEventListener("fcm-message",l),()=>window.removeEventListener("fcm-message",l)},[u,s]),s?e.jsxs("div",{className:"flex-1 flex flex-col h-full",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 flex items-center gap-3",children:[h&&e.jsx("button",{type:"button",onClick:()=>j&&j(),className:"p-2 -ml-2 mr-1 rounded-full hover:bg-gray-100",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-gray-700",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),e.jsx("div",{className:"w-10 h-10 rounded-full bg-indigo-200 flex items-center justify-center text-white font-semibold",children:s.name.split(" ").map(l=>l[0]).slice(0,2).join("")}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.name}),e.jsx("div",{className:"text-xs text-gray-500",children:s.lastMessage})]})]}),e.jsxs("div",{className:"p-4 overflow-y-auto flex-1 relative",children:[c&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-white/60 z-10",children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx("div",{className:"h-8 w-8 border-4 border-t-primary-600 border-gray-200 rounded-full animate-spin"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Carregando mensagens..."})]})}),!c&&(!t||t.length===0)?e.jsx("div",{className:"h-full flex items-center justify-center text-gray-500",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mb-2",children:"Nenhuma mensagem ainda"}),e.jsx("div",{className:"text-xs",children:"Envie a primeira mensagem para iniciar a conversa."})]})}):t.map(l=>e.jsx(G,{message:l},l.id)),e.jsx("div",{ref:v})]}),e.jsx(J,{onSend:i,sending:p})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsx("div",{className:"text-gray-500",children:"Selecione um contato para iniciar a conversa"})})}const V=[];function ee(){const[s,t]=f.useState(V.map(a=>({...a}))),[i,c]=f.useState(null),[u,p]=f.useState(!0),[h,j]=f.useState(null),[v,l]=f.useState(null),[n,g]=f.useState(null);function d(a){c(a),t(m=>m.map(x=>x.id===a?{...x,unread:0}:x));const o=s.find(m=>m.id===a);o&&((!o.messages||o.messages.length===0)&&b(a),y&&N(!1))}function C(a){if(!i)return;const o=s.find(m=>m.id===i);o&&(g(i),window.axios.post(route("chat.api.storeMessage"),{usuario_id:o.id,mensagem:a,remetente:"me"}).then(()=>{g(null)}).catch(m=>{g(null),console.error("Erro ao enviar mensagem",m)}))}const w=s.find(a=>a.id===i)||null,[y,k]=f.useState(typeof window<"u"?window.innerWidth<768:!1),[S,N]=f.useState(!0);f.useEffect(()=>{function a(){const o=window.innerWidth<768;k(o),o||N(!0)}return window.addEventListener("resize",a),a(),()=>window.removeEventListener("resize",a)},[]),f.useEffect(()=>{p(!0),window.axios.get(route("chat.api.contacts")).then(a=>{if(a.data&&a.data.groups){l(a.data.groups);const o=a.data.groups[0]?.items?.[0];o&&c(x=>x??o.id);const m=a.data.groups.flatMap(x=>x.items.map(r=>({...r,messages:r.messages||[]})));t(m)}else{const o=a.data.map(m=>({...m,messages:m.messages||[]}));t(o),o.length>0&&c(m=>m??o[0].id)}}).catch(a=>{console.warn("Não foi possível carregar contatos via API, usando mock",a)}).finally(()=>p(!1))},[]);function E(a,o){t(m=>m.map(x=>{if(x.id!==o)return x;const r=[...x.messages||[],a];return{...x,messages:r,lastMessage:a.text,unread:i===o?0:(x.unread||0)+1}}))}f.useEffect(()=>{const a={current:{}};function o(m){const x=m.detail||m;let r=x.data||x;if(typeof r=="string")try{r=JSON.parse(r)}catch{}const L=r.usuario_id||r.data&&r.data.usuario_id||r.user_id||r.usuario||null;if(r.mensagem||r.data&&r.data.mensagem||r.message||r.notification&&r.notification.body,!L)return;const H=Date.now();a.current[L],a.current[L]=H;const A=r.id||r.message_id||Date.now();console.log(r),t(_=>_.map(M=>M.id!=L||(M.messages||[]).some(F=>F.id==A)?M:{...M,lastMessage:r.mensagem,unread:(M.unread||0)+1,messages:[...M.messages||[],{id:A,from:r.remetente||"them",text:r.mensagem,time:r.time||new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),type:r.type}]})),b(L)}return window.addEventListener("fcm-message",o),()=>window.removeEventListener("fcm-message",o)},[i]);function b(a){j(a),window.axios.get(route("chat.api.messages",{usuario:a})).then(o=>{const m=o.data;t(x=>x.map(r=>r.id!==a?r:{...r,messages:m})),w?.id===a&&(w.messages=m)}).catch(o=>{console.warn("Erro ao buscar mensagens",o)}).finally(()=>j(null))}return e.jsxs(T,{header:e.jsx("h2",{className:"text-xl font-semibold leading-tight text-gray-800",children:"Chat de Contatos"}),children:[e.jsx(z,{title:"Chat"}),e.jsx("div",{className:"py-6",children:e.jsx("div",{className:"mx-auto max-w-7xl sm:px-6 lg:px-8",children:e.jsx("div",{className:"bg-white shadow-sm sm:rounded-lg overflow-hidden",style:{height:"70vh"},children:e.jsxs("div",{className:"flex h-full flex-col md:flex-row relative",children:[(!y||S)&&e.jsx(P,{contacts:s,selectedId:i,onSelect:d,groups:v}),y?e.jsx("div",{className:`flex-1 h-full ${S?"hidden":"block"}`,children:e.jsx($,{contact:w,messages:w?.messages||[],onReceive:E,onSend:C,loading:h===i,sending:n===i,isMobile:!0,onBack:()=>N(!0)})}):e.jsx("div",{className:"flex-1 h-full",children:e.jsx($,{contact:w,messages:w?.messages||[],onReceive:E,onSend:C,loading:h===i,sending:n===i,isMobile:!1})}),y&&S&&e.jsx("button",{type:"button",onClick:()=>{},className:"fixed bottom-6 right-6 bg-green-500 shadow-lg text-white rounded-full w-14 h-14 flex items-center justify-center",title:"Novo contato",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})})})]})})})})]})}export{ee as default};
