import{r as v,j as e,H as S}from"./app-P39dN2Sv.js";import{A as E}from"./AuthenticatedLayout-FIw6WA9q.js";import"./ApplicationLogo-CoW0dvPv.js";import"./transition-BMVh1o14.js";function L(t){const r=t.messages&&t.messages.length?t.messages[t.messages.length-1].time:t.lastMessage||"";if(!r)return"Anteriores";const n=String(r).toLowerCase();return n.includes("hoje")||/^\d{1,2}:\d{2}$/.test(n)?"Hoje":n.includes("ontem")?"Ontem":"Anteriores"}function P(t){const r=d=>{if(!d)return NaN;const g=Date.parse(d);if(!isNaN(g))return g;const u=String(d).trim().toLowerCase(),f=u.match(/^(\d{1,2}):(\d{2})$/);if(f){const x=new Date;return x.setHours(parseInt(f[1],10),parseInt(f[2],10),0,0),x.getTime()}if(u.includes("hoje"))return Date.now();if(u.includes("ontem")){const x=new Date;return x.setDate(x.getDate()-1),x.getTime()}return NaN};if(t.lastAt){const d=r(t.lastAt);if(!isNaN(d))return d}const n=t.messages&&t.messages.length?t.messages[t.messages.length-1].time:t.lastMessage,m=r(n);return isNaN(m)?0:m}function R({contacts:t=[],selectedId:r,onSelect:n,groups:m=null}){const[d,g]=v.useState(""),u=v.useMemo(()=>t.filter(s=>s.name.toLowerCase().includes(d.toLowerCase())||(s.lastMessage||"").toLowerCase().includes(d.toLowerCase())).sort((s,h)=>P(h)-P(s)),[t,d]),f=v.useMemo(()=>{if(m&&Array.isArray(m)&&m.length)return null;const a={Hoje:[],Ontem:[],Anteriores:[]};return u.forEach(s=>{const h=L(s);a[h]||(a[h]=[]),a[h].push(s)}),a},[u,m]),x=["Hoje","Ontem","Anteriores"];return e.jsxs("div",{className:"w-80 border-r border-gray-200 h-full flex flex-col",children:[e.jsx("div",{className:"p-4",children:e.jsx("input",{className:"w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500",placeholder:"Pesquisar contatos",value:d,onChange:a=>g(a.target.value)})}),e.jsx("div",{className:"overflow-y-auto flex-1",children:m&&Array.isArray(m)&&m.length?m.map(a=>e.jsxs("div",{className:"pb-3",children:[e.jsx("div",{className:"px-4 py-2 text-xs font-semibold text-gray-500 uppercase",children:a.label}),a.items.map(s=>e.jsxs("button",{onClick:()=>n(s.id),className:`w-full text-left p-4 hover:bg-gray-50 flex items-start gap-3 ${r===s.id?"bg-gray-100":""}`,children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-indigo-200 flex items-center justify-center text-white font-semibold",children:String(s.name).split(" ").map(h=>h[0]).slice(0,2).join("")}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-medium text-sm",children:s.name}),s.unread>0&&e.jsx("div",{className:"text-xs bg-red-500 text-white rounded-full px-2 py-0.5",children:s.unread})]}),e.jsx("div",{className:"text-xs text-gray-500 truncate",children:s.lastMessage})]})]},s.id))]},a.key)):x.map(a=>f[a]&&f[a].length>0?e.jsxs("div",{className:"pb-3",children:[e.jsx("div",{className:"px-4 py-2 text-xs font-semibold text-gray-500 uppercase",children:a}),f[a].map(s=>e.jsxs("button",{onClick:()=>n(s.id),className:`w-full text-left p-4 hover:bg-gray-50 flex items-start gap-3 ${r===s.id?"bg-gray-100":""}`,children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-indigo-200 flex items-center justify-center text-white font-semibold",children:s.name.split(" ").map(h=>h[0]).slice(0,2).join("")}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-medium text-sm",children:s.name}),s.unread>0&&e.jsx("div",{className:"text-xs bg-red-500 text-white rounded-full px-2 py-0.5",children:s.unread})]}),e.jsx("div",{className:"text-xs text-gray-500 truncate",children:s.lastMessage})]})]},s.id))]},a):null)})]})}function D({message:t}){const r=t.from==="me";return e.jsx("div",{className:`flex ${r?"justify-end":"justify-start"} mb-2`,children:e.jsxs("div",{className:`${r?"bg-indigo-600 text-white":"bg-gray-100 text-gray-800"} max-w-xs p-3 rounded-lg`,children:[e.jsx("div",{className:"text-sm",children:t.text}),e.jsx("div",{className:`text-xs mt-1 ${r?"text-indigo-100":"text-gray-500"}`,children:t.time})]})})}function T({onSend:t}){const[r,n]=v.useState("");function m(d){d.preventDefault();const g=r.trim();g&&(t(g),n(""))}return e.jsxs("form",{onSubmit:m,className:"p-3 border-t border-gray-200 flex gap-2 items-center",children:[e.jsx("input",{value:r,onChange:d=>n(d.target.value),className:"flex-1 rounded-md border-gray-300 shadow-sm px-3 py-2 focus:outline-none",placeholder:"Escreva uma mensagem..."}),e.jsx("button",{className:"bg-indigo-600 text-white px-4 py-2 rounded-md",type:"submit",children:"Enviar"})]})}function H({contact:t,messages:r=[],onSend:n,loading:m=!1,onReceive:d}){const g=v.useRef(null);return v.useEffect(()=>{g.current?.scrollIntoView({behavior:"smooth"})},[r,t]),v.useEffect(()=>{if(!d)return;function u(f){const x=f.detail||f;let a=x.data||x;if(typeof a=="string")try{a=JSON.parse(a)}catch{}const s=a.usuario_id||a.data&&a.data.usuario_id||a.user_id||a.usuario||null;if(!s||!t||s!==t.id)return;const h=a.mensagem||a.data&&a.data.mensagem||a.message||a.notification&&a.notification.body||"",M=a.remetente||a.data&&a.data.remetente||"user",w=a.id||a.message_id||Date.now(),C=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),i={id:w,from:M==="me"?"me":"other",text:h,time:C};try{d(i,s)}catch(o){console.error("onReceive handler error",o)}}return window.addEventListener("fcm-message",u),()=>window.removeEventListener("fcm-message",u)},[d,t]),t?e.jsxs("div",{className:"flex-1 flex flex-col h-full",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-indigo-200 flex items-center justify-center text-white font-semibold",children:t.name.split(" ").map(u=>u[0]).slice(0,2).join("")}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:t.name}),e.jsx("div",{className:"text-xs text-gray-500",children:t.lastMessage})]})]}),e.jsxs("div",{className:"p-4 overflow-y-auto flex-1 relative",children:[m&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-white/60 z-10",children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx("div",{className:"h-8 w-8 border-4 border-t-indigo-600 border-gray-200 rounded-full animate-spin"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Carregando mensagens..."})]})}),!m&&(!r||r.length===0)?e.jsx("div",{className:"h-full flex items-center justify-center text-gray-500",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mb-2",children:"Nenhuma mensagem ainda"}),e.jsx("div",{className:"text-xs",children:"Envie a primeira mensagem para iniciar a conversa."})]})}):r.map(u=>e.jsx(D,{message:u},u.id)),e.jsx("div",{ref:g})]}),e.jsx(T,{onSend:n})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsx("div",{className:"text-gray-500",children:"Selecione um contato para iniciar a conversa"})})}const $=[{id:1,name:"João Silva",avatar:null,unread:2,lastMessage:"Até mais tarde!",messages:[{id:1,from:"contact",text:"Olá, você tem um minuto?",time:"09:10"},{id:2,from:"me",text:"Tenho sim, diga.",time:"09:12"},{id:3,from:"contact",text:"Perfeito — até mais tarde!",time:"09:15"}]},{id:2,name:"Maria Oliveira",avatar:null,unread:0,lastMessage:"Obrigado pelo retorno.",messages:[{id:1,from:"contact",text:"Você pode me encaminhar os documentos?",time:"08:05"},{id:2,from:"me",text:"Já enviei por e-mail.",time:"08:10"},{id:3,from:"contact",text:"Obrigado pelo retorno.",time:"08:12"}]},{id:3,name:"Carlos Pereira",avatar:null,unread:5,lastMessage:"Pode ligar mais tarde?",messages:[{id:1,from:"contact",text:"Oi, está disponível?",time:"Ontem"},{id:2,from:"contact",text:"Preciso agendar uma reunião.",time:"Ontem"},{id:3,from:"me",text:"Posso sim — qual horário?",time:"Ontem"},{id:4,from:"contact",text:"Pode ligar mais tarde?",time:"Hoje"}]},{id:4,name:"Ana Souza",avatar:null,unread:0,lastMessage:"Recebi, obrigado.",messages:[{id:1,from:"me",text:"Enviei o contrato.",time:"10:05"},{id:2,from:"contact",text:"Recebi, obrigado.",time:"10:07"}]},{id:5,name:"Pedro Lima",avatar:null,unread:1,lastMessage:"Amanhã de manhã?",messages:[{id:1,from:"contact",text:"Tem como amanhã de manhã?",time:"Ontem"}]},{id:6,name:"Mariana Costa",avatar:null,unread:0,lastMessage:"Confirmado.",messages:[{id:1,from:"me",text:"Agendei para sexta.",time:"09:00"},{id:2,from:"contact",text:"Confirmado.",time:"09:02"}]},{id:7,name:"Lucas Ferreira",avatar:null,unread:3,lastMessage:"Enviei as fotos.",messages:[{id:1,from:"contact",text:"Enviei as fotos.",time:"08:30"},{id:2,from:"me",text:"Recebi, vou olhar.",time:"08:45"}]},{id:8,name:"Patrícia Gomes",avatar:null,unread:0,lastMessage:"Obrigado pela atenção.",messages:[{id:1,from:"contact",text:"Obrigado pela atenção.",time:"Ontem"}]},{id:9,name:"Rafael Alves",avatar:null,unread:0,lastMessage:"Ok, combinado.",messages:[{id:1,from:"me",text:"Posso ligar às 15h?",time:"14:55"},{id:2,from:"contact",text:"Ok, combinado.",time:"14:57"}]},{id:10,name:"Sofia Martins",avatar:null,unread:0,lastMessage:"Recebi a confirmação.",messages:[{id:1,from:"contact",text:"Recebi a confirmação.",time:"Ontem"}]},{id:11,name:"Bruno Rocha",avatar:null,unread:0,lastMessage:"Obrigado!",messages:[{id:1,from:"me",text:"Pronto, verifiquei.",time:"11:20"},{id:2,from:"contact",text:"Obrigado!",time:"11:22"}]},{id:12,name:"Camila Ribeiro",avatar:null,unread:2,lastMessage:"Pode enviar novamente?",messages:[{id:1,from:"contact",text:"Não chegou o arquivo.",time:"Ontem"},{id:2,from:"contact",text:"Pode enviar novamente?",time:"Hoje"}]},{id:13,name:"Diego Nunes",avatar:null,unread:0,lastMessage:"Tudo certo.",messages:[{id:1,from:"contact",text:"Tudo certo.",time:"2025-10-28"}]},{id:14,name:"Elisa Andrade",avatar:null,unread:0,lastMessage:"Aguardo retorno.",messages:[{id:1,from:"contact",text:"Aguardo retorno.",time:"2025-10-25"}]},{id:15,name:"Fábio Mendes",avatar:null,unread:0,lastMessage:"Posso ligar?",messages:[{id:1,from:"contact",text:"Posso ligar?",time:"Ontem"}]},{id:16,name:"Gabriela Pinto",avatar:null,unread:4,lastMessage:"Envie-me o orçamento.",messages:[{id:1,from:"contact",text:"Envie-me o orçamento.",time:"07:40"},{id:2,from:"me",text:"Já enviei.",time:"07:55"}]},{id:17,name:"Henrique Carvalho",avatar:null,unread:0,lastMessage:"Obrigado pelo suporte.",messages:[{id:1,from:"contact",text:"Obrigado pelo suporte.",time:"2025-09-10"}]},{id:18,name:"Isabela Castro",avatar:null,unread:0,lastMessage:"Posso confirmar?",messages:[{id:1,from:"contact",text:"Posso confirmar?",time:"Ontem"}]},{id:19,name:"Joana Lima",avatar:null,unread:1,lastMessage:"Vamos marcar?",messages:[{id:1,from:"contact",text:"Vamos marcar?",time:"09:45"}]},{id:20,name:"Kevin Barros",avatar:null,unread:0,lastMessage:"Recebido.",messages:[{id:1,from:"me",text:"Enviei o relatório.",time:"2025-10-01"},{id:2,from:"contact",text:"Recebido.",time:"2025-10-02"}]},{id:21,name:"Larissa Freitas",avatar:null,unread:0,lastMessage:"Confirmado! Obrigada",messages:[{id:1,from:"contact",text:"Confirmado! Obrigada",time:"Ontem"}]},{id:22,name:"Marcelo Dias",avatar:null,unread:0,lastMessage:"Vou revisar e retorno.",messages:[{id:1,from:"contact",text:"Vou revisar e retorno.",time:"2025-09-20"}]},{id:23,name:"Natália Lopes",avatar:null,unread:0,lastMessage:"Perfeito.",messages:[{id:1,from:"me",text:"Atualizei o documento.",time:"13:00"},{id:2,from:"contact",text:"Perfeito.",time:"13:05"}]},{id:24,name:"Otávio Reis",avatar:null,unread:2,lastMessage:"Qual o valor?",messages:[{id:1,from:"contact",text:"Qual o valor?",time:"08:15"},{id:2,from:"contact",text:"Pode me enviar a tabela?",time:"08:16"}]},{id:25,name:"Priscila Moraes",avatar:null,unread:0,lastMessage:"Agradeço o retorno.",messages:[{id:1,from:"contact",text:"Agradeço o retorno.",time:"2025-08-30"}]},{id:26,name:"Quintino Alves",avatar:null,unread:0,lastMessage:"Confirmado",messages:[{id:1,from:"contact",text:"Confirmado",time:"Ontem"}]},{id:27,name:"Rosa Fernandes",avatar:null,unread:0,lastMessage:"Até breve",messages:[{id:1,from:"contact",text:"Até breve",time:"2025-07-12"}]},{id:28,name:"Samuel Teixeira",avatar:null,unread:0,lastMessage:"Podemos reagendar?",messages:[{id:1,from:"contact",text:"Podemos reagendar?",time:"Ontem"}]},{id:29,name:"Talita Nascimento",avatar:null,unread:0,lastMessage:"Recebido, obrigada.",messages:[{id:1,from:"me",text:"Enviei os detalhes.",time:"10:30"},{id:2,from:"contact",text:"Recebido, obrigada.",time:"10:32"}]},{id:30,name:"Uiliam Gomes",avatar:null,unread:6,lastMessage:"Preciso falar urgente.",messages:[{id:1,from:"contact",text:"Preciso falar urgente.",time:"07:10"},{id:2,from:"contact",text:"Você está disponível?",time:"07:12"}]}];function k(){const[t,r]=v.useState($.map(i=>({...i}))),[n,m]=v.useState(null),[d,g]=v.useState(!0),[u,f]=v.useState(null),[x,a]=v.useState(null);function s(i){m(i),r(l=>l.map(c=>c.id===i?{...c,unread:0}:c));const o=t.find(l=>l.id===i);o&&(!o.messages||o.messages.length===0)&&C(i)}function h(i){if(!n)return;const o=t.find(j=>j.id===n);if(!o)return;const l=`temp_${Date.now()}`,c=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),b={id:l,from:"me",text:i,time:c};r(j=>j.map(p=>p.id!==n?p:{...p,messages:[...p.messages||[],b],lastMessage:i})),window.axios.post(route("chat.api.storeMessage"),{usuario_id:o.id,mensagem:i,remetente:"me"}).then(j=>{const p=j.data.data;r(N=>N.map(y=>{if(y.id!==n)return y;const A=(y.messages||[]).map(O=>O.id===l?{id:p.id,from:p.from,text:p.text,time:p.time}:O);return{...y,messages:A,lastMessage:p.text}}))}).catch(j=>{r(p=>p.map(N=>N.id!==n?N:{...N,messages:(N.messages||[]).filter(y=>y.id!==l)})),console.error("Erro ao enviar mensagem",j)})}const M=t.find(i=>i.id===n)||null;v.useEffect(()=>{g(!0),window.axios.get(route("chat.api.contacts")).then(i=>{if(i.data&&i.data.groups){a(i.data.groups);const o=i.data.groups[0]?.items?.[0];o&&m(c=>c??o.id);const l=i.data.groups.flatMap(c=>c.items.map(b=>({...b,messages:b.messages||[]})));r(l)}else{const o=i.data.map(l=>({...l,messages:l.messages||[]}));r(o),o.length>0&&m(l=>l??o[0].id)}}).catch(i=>{console.warn("Não foi possível carregar contatos via API, usando mock",i)}).finally(()=>g(!1))},[]);function w(i,o){r(l=>l.map(c=>{if(c.id!==o)return c;const b=[...c.messages||[],i];return{...c,messages:b,lastMessage:i.text,unread:n===o?0:(c.unread||0)+1}}))}function C(i){f(i),window.axios.get(route("chat.api.messages",{usuario:i})).then(o=>{const l=o.data;r(c=>c.map(b=>b.id!==i?b:{...b,messages:l}))}).catch(o=>{console.warn("Erro ao buscar mensagens",o)}).finally(()=>f(null))}return e.jsxs(E,{header:e.jsx("h2",{className:"text-xl font-semibold leading-tight text-gray-800",children:"Chat de Contatos"}),children:[e.jsx(S,{title:"Chat"}),e.jsx("div",{className:"py-6",children:e.jsx("div",{className:"mx-auto max-w-7xl sm:px-6 lg:px-8",children:e.jsx("div",{className:"bg-white shadow-sm sm:rounded-lg overflow-hidden",style:{height:"70vh"},children:e.jsxs("div",{className:"flex h-full",children:[e.jsx(R,{contacts:t,selectedId:n,onSelect:s,groups:x}),e.jsx("div",{className:"flex-1 h-full",children:e.jsx(H,{contact:M,messages:M?.messages||[],onReceive:w,onSend:h,loading:u===n})})]})})})})]})}export{k as default};
