import{r as c,j as e,H as T}from"./app-DFiUFAf9.js";import{A as z}from"./AuthenticatedLayout-B12wbkOI.js";import"./ApplicationLogo-DU-ZxA8n.js";import"./transition-sjcMKq9g.js";function B(s){const t=s.messages&&s.messages.length?s.messages[s.messages.length-1].time:s.lastMessage||"";if(!t)return"Anteriores";const a=String(t).toLowerCase();return a.includes("hoje")||/^\d{1,2}:\d{2}$/.test(a)?"Hoje":a.includes("ontem")?"Ontem":"Anteriores"}function $(s){const t=m=>{if(!m)return NaN;const f=Date.parse(m);if(!isNaN(f))return f;const h=String(m).trim().toLowerCase(),p=h.match(/^(\d{1,2}):(\d{2})$/);if(p){const j=new Date;return j.setHours(parseInt(p[1],10),parseInt(p[2],10),0,0),j.getTime()}if(h.includes("hoje"))return Date.now();if(h.includes("ontem")){const j=new Date;return j.setDate(j.getDate()-1),j.getTime()}return NaN};if(s.lastAt){const m=t(s.lastAt);if(!isNaN(m))return m}const a=s.messages&&s.messages.length?s.messages[s.messages.length-1].time:s.lastMessage,o=t(a);return isNaN(o)?0:o}function O({contacts:s=[],selectedId:t,onSelect:a,groups:o=null}){const[m,f]=c.useState(""),h=c.useMemo(()=>s.filter(n=>n.name.toLowerCase().includes(m.toLowerCase())||(n.lastMessage||"").toLowerCase().includes(m.toLowerCase())).sort((n,w)=>$(w)-$(n)),[s,m]),p=c.useMemo(()=>{if(o&&Array.isArray(o)&&o.length)return null;const l={Hoje:[],Ontem:[],Anteriores:[]};return h.forEach(n=>{const w=B(n);l[w]||(l[w]=[]),l[w].push(n)}),l},[h,o]),j=["Hoje","Ontem","Anteriores"];return e.jsxs("div",{className:"w-full md:w-80 max-w-xs border-gray-200 h-full flex flex-col md:border-r md:border-b-0 border-b",style:{maxWidth:"320px"},children:[e.jsx("div",{className:"p-4",children:e.jsx("input",{className:"w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500",placeholder:"Pesquisar contatos",value:m,onChange:l=>f(l.target.value)})}),e.jsx("div",{className:"overflow-y-auto flex-1",children:o&&Array.isArray(o)&&o.length?o.map(l=>e.jsxs("div",{className:"pb-3",children:[e.jsx("div",{className:"px-4 py-2 text-xs font-semibold text-gray-500 uppercase",children:l.label}),l.items.map(n=>e.jsxs("button",{onClick:()=>a(n.id),className:`w-full text-left p-4 hover:bg-gray-50 flex items-start gap-3 ${t===n.id?"bg-gray-100":""}`,children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-indigo-200 flex items-center justify-center text-white font-semibold",children:String(n.name).split(" ").map(w=>w[0]).slice(0,2).join("")}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-medium text-sm",children:n.name}),n.unread>0&&e.jsx("div",{className:"text-xs bg-red-500 text-white rounded-full px-2 py-0.5",children:n.unread})]}),e.jsx("div",{className:"text-xs text-gray-500 truncate max-w-[200px]",children:n.lastMessage})]})]},n.id))]},l.key)):j.map(l=>p[l]&&p[l].length>0?e.jsxs("div",{className:"pb-3",children:[e.jsx("div",{className:"px-4 py-2 text-xs font-semibold text-gray-500 uppercase",children:l}),p[l].map(n=>e.jsxs("button",{onClick:()=>a(n.id),className:`w-full text-left p-4 hover:bg-gray-50 flex items-start gap-3 ${t===n.id?"bg-gray-100":""}`,children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-indigo-200 flex items-center justify-center text-white font-semibold",children:n.name.split(" ").map(w=>w[0]).slice(0,2).join("")}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-medium text-sm",children:n.name}),n.unread>0&&e.jsx("div",{className:"text-xs bg-red-500 text-white rounded-full px-2 py-0.5",children:n.unread})]}),e.jsx("div",{className:"text-xs text-gray-500 truncate max-w-[200px]",children:n.lastMessage})]})]},n.id))]},l):null)})]})}/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const P=s=>s.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),q=s=>s.replace(/^([A-Z])|[\s-_]+(\w)/g,(t,a,o)=>o?o.toUpperCase():a.toLowerCase()),D=s=>{const t=q(s);return t.charAt(0).toUpperCase()+t.slice(1)},H=(...s)=>s.filter((t,a,o)=>!!t&&t.trim()!==""&&o.indexOf(t)===a).join(" ").trim(),U=s=>{for(const t in s)if(t.startsWith("aria-")||t==="role"||t==="title")return!0};/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */var G={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const J=c.forwardRef(({color:s="currentColor",size:t=24,strokeWidth:a=2,absoluteStrokeWidth:o,className:m="",children:f,iconNode:h,...p},j)=>c.createElement("svg",{ref:j,...G,width:t,height:t,stroke:s,strokeWidth:o?Number(a)*24/Number(t):a,className:H("lucide",m),...!f&&!U(p)&&{"aria-hidden":"true"},...p},[...h.map(([l,n])=>c.createElement(l,n)),...Array.isArray(f)?f:[f]]));/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const F=(s,t)=>{const a=c.forwardRef(({className:o,...m},f)=>c.createElement(J,{ref:f,iconNode:t,className:H(`lucide-${P(D(s))}`,`lucide-${s}`,o),...m}));return a.displayName=D(s),a};/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const V=[["path",{d:"M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z",key:"18887p"}]],Z=F("message-square",V);/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const K=[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]],Q=F("user",K);function X({message:s}){const t=s.from==="me"||s.from==="bot",a=t?Q:Z;return e.jsx("div",{className:`flex ${t?"justify-end":"justify-start"} mb-2`,children:e.jsxs("div",{className:`${t?"bg-primary text-white":"bg-gray-100 text-gray-800"} max-w-xs p-3 rounded-lg flex items-end gap-2`,children:[!t&&e.jsx("div",{className:"flex-shrink-0 mt-0",children:e.jsx(a,{size:18,className:"text-gray-500"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm",children:s.text}),e.jsx("div",{className:`text-xs mt-1 ${t?"text-primary-100":"text-gray-500"}`,children:s.time})]}),t&&e.jsx("div",{className:"flex-shrink-0",children:e.jsx(a,{size:18,className:"text-primary-100"})})]})})}function Y({onSend:s,sending:t=!1}){const[a,o]=c.useState("");function m(f){f.preventDefault();const h=a.trim();!h||t||(s(h),o(""))}return e.jsxs("form",{onSubmit:m,className:"p-3 border-t border-gray-200 flex gap-2 items-center",children:[e.jsx("input",{value:a,onChange:f=>o(f.target.value),className:"flex-1 rounded-md border-gray-300 shadow-sm px-3 py-2 focus:outline-none",placeholder:"Escreva uma mensagem...",disabled:t}),e.jsx("button",{className:`px-4 py-2 rounded-md ${t?"bg-gray-300 text-gray-700":"bg-primary text-white"}`,type:"submit",disabled:t,children:t?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-4 w-4 border-2 border-t-primary-600 border-gray-200 rounded-full animate-spin"}),e.jsx("span",{className:"text-sm",children:"Enviando..."})]}):"Enviar"})]})}function I({contact:s,messages:t=[],onSend:a,loading:o=!1,onReceive:m,sending:f=!1,isMobile:h=!1,onBack:p=null}){const j=c.useRef(null);return c.useEffect(()=>{j.current?.scrollIntoView({behavior:"smooth"})},[t,s]),c.useEffect(()=>{if(!m)return;function l(n){const w=n.detail||n;let u=w.data||w;if(typeof u=="string")try{u=JSON.parse(u)}catch{}const L=u.usuario_id||u.data&&u.data.usuario_id||u.user_id||u.usuario||null;if(!L||!s||L!=s.id)return;const v=u.mensagem||u.data&&u.data.mensagem||u.message||u.notification&&u.notification.body||"",y=u.remetente||u.data&&u.data.remetente||"user";console.log("FCM message for current contact:",y);const S=u.id||u.message_id||Date.now(),M=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),b={id:S,from:y==="me"?"me":"other",text:v,time:M};if(!(Array.isArray(t)&&t.some(N=>N.id==b.id))){console.log("new message:",b,u.data);try{m(b,L)}catch(N){console.error("onReceive handler error",N)}}}return window.addEventListener("fcm-message",l),()=>window.removeEventListener("fcm-message",l)},[m,s]),s?e.jsxs("div",{className:"flex-1 flex flex-col h-full",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 flex items-center gap-3",children:[h&&e.jsx("button",{type:"button",onClick:()=>p&&p(),className:"p-2 -ml-2 mr-1 rounded-full hover:bg-gray-100",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-gray-700",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),e.jsx("div",{className:"w-10 h-10 rounded-full bg-indigo-200 flex items-center justify-center text-white font-semibold",children:s.name.split(" ").map(l=>l[0]).slice(0,2).join("")}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.name}),e.jsx("div",{className:"text-xs text-gray-500",children:s.lastMessage})]})]}),e.jsxs("div",{className:"p-4 overflow-y-auto flex-1 relative",children:[o&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-white/60 z-10",children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx("div",{className:"h-8 w-8 border-4 border-t-primary-600 border-gray-200 rounded-full animate-spin"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Carregando mensagens..."})]})}),!o&&(!t||t.length===0)?e.jsx("div",{className:"h-full flex items-center justify-center text-gray-500",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mb-2",children:"Nenhuma mensagem ainda"}),e.jsx("div",{className:"text-xs",children:"Envie a primeira mensagem para iniciar a conversa."})]})}):t.map(l=>e.jsx(X,{message:l},l.id)),e.jsx("div",{ref:j})]}),e.jsx(Y,{onSend:a,sending:f})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsx("div",{className:"text-gray-500",children:"Selecione um contato para iniciar a conversa"})})}const ee=[];function ie(){const[s,t]=c.useState(ee.map(r=>({...r}))),[a,o]=c.useState(null),[m,f]=c.useState(!0),[h,p]=c.useState(null),[j,l]=c.useState(null),[n,w]=c.useState(null);function u(r){o(r),t(x=>x.map(g=>g.id===r?{...g,unread:0}:g));const d=s.find(x=>x.id===r);d&&((!d.messages||d.messages.length===0)&&N(r),y&&b(!1))}function L(r){if(!a)return;const d=s.find(x=>x.id===a);d&&(w(a),window.axios.post(route("chat.api.storeMessage"),{usuario_id:d.id,mensagem:r,remetente:"me"}).then(()=>{w(null)}).catch(x=>{w(null),console.error("Erro ao enviar mensagem",x)}))}const v=s.find(r=>r.id===a)||null,[y,S]=c.useState(typeof window<"u"?window.innerWidth<768:!1),[M,b]=c.useState(!0);c.useEffect(()=>{function r(){const d=window.innerWidth<768;S(d),d||b(!0)}return window.addEventListener("resize",r),r(),()=>window.removeEventListener("resize",r)},[]),c.useEffect(()=>{f(!0),window.axios.get(route("chat.api.contacts")).then(r=>{if(r.data&&r.data.groups){l(r.data.groups);const d=r.data.groups[0]?.items?.[0];d&&o(g=>g??d.id);const x=r.data.groups.flatMap(g=>g.items.map(i=>({...i,messages:i.messages||[]})));t(x)}else{const d=r.data.map(x=>({...x,messages:x.messages||[]}));t(d),d.length>0&&o(x=>x??d[0].id)}}).catch(r=>{console.warn("Não foi possível carregar contatos via API, usando mock",r)}).finally(()=>f(!1))},[]);function E(r,d){t(x=>x.map(g=>{if(g.id!==d)return g;const i=[...g.messages||[],r];return{...g,messages:i,lastMessage:r.text,unread:a===d?0:(g.unread||0)+1}}))}c.useEffect(()=>{const r={current:{}};function d(x){const g=x.detail||x;let i=g.data||g;if(typeof i=="string")try{i=JSON.parse(i)}catch{}const k=i.usuario_id||i.data&&i.data.usuario_id||i.user_id||i.usuario||null;if(i.mensagem||i.data&&i.data.mensagem||i.message||i.notification&&i.notification.body,!k)return;const W=Date.now();r.current[k],r.current[k]=W;const A=i.id||i.message_id||Date.now();console.log(i),t(_=>_.map(C=>C.id!=k||(C.messages||[]).some(R=>R.id==A)?C:{...C,lastMessage:i.mensagem,unread:(C.unread||0)+1,messages:[...C.messages||[],{id:A,from:i.remetente||"them",text:i.mensagem,time:i.time||new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),type:i.type}]})),N(k)}return window.addEventListener("fcm-message",d),()=>window.removeEventListener("fcm-message",d)},[a]);function N(r){p(r),window.axios.get(route("chat.api.messages",{usuario:r})).then(d=>{const x=d.data;t(g=>g.map(i=>i.id!==r?i:{...i,messages:x})),v?.id===r&&(v.messages=x)}).catch(d=>{console.warn("Erro ao buscar mensagens",d)}).finally(()=>p(null))}return e.jsxs(z,{header:e.jsx("h2",{className:"text-xl font-semibold leading-tight text-gray-800",children:"Chat de Contatos"}),children:[e.jsx(T,{title:"Chat"}),e.jsx("div",{className:"py-6",children:e.jsx("div",{className:"mx-auto max-w-7xl sm:px-6 lg:px-8",children:e.jsx("div",{className:"bg-white shadow-sm sm:rounded-lg overflow-hidden",style:{height:"70vh"},children:e.jsxs("div",{className:"flex h-full flex-col md:flex-row relative",children:[(!y||M)&&e.jsx(O,{contacts:s,selectedId:a,onSelect:u,groups:j}),y?e.jsx("div",{className:`flex-1 h-full ${M?"hidden":"block"}`,children:e.jsx(I,{contact:v,messages:v?.messages||[],onReceive:E,onSend:L,loading:h===a,sending:n===a,isMobile:!0,onBack:()=>b(!0)})}):e.jsx("div",{className:"flex-1 h-full",children:e.jsx(I,{contact:v,messages:v?.messages||[],onReceive:E,onSend:L,loading:h===a,sending:n===a,isMobile:!1})}),y&&M&&e.jsx("button",{type:"button",onClick:()=>{},className:"fixed bottom-6 right-6 bg-green-500 shadow-lg text-white rounded-full w-14 h-14 flex items-center justify-center",title:"Novo contato",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})})})]})})})})]})}export{ie as default};
